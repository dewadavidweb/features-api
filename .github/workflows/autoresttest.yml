
name: AutoRestTest CI

on:
  push:
    branches:
      - main

jobs:
  run-autoresttest:
    runs-on: ubuntu-latest
    environment: "AutoRestTest Web"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run AutoRestTest
        run: |
          set -e

          if [ ! -f "features.json" ]; then
            echo "Error: Spec file not found at features.json"
            exit 1
          fi

          PAYLOAD=$(node -e "
            const fs = require('fs');
            const spec = require('./features.json');
            const data = {
              spec: JSON.stringify(spec),
              config: {\"api_url_override\":\"http://103.167.133.167/features\",\"llm_engine\":\"gpt-4\",\"llm_engine_temperature\":0.7,\"use_cached_graph\":true,\"use_cached_q_tables\":true,\"rl_agent_learning_rate\":0.1,\"rl_agent_discount_factor\":0.9,\"rl_agent_max_exploration\":1,\"time_duration_seconds\":60,\"mutation_rate\":0.1,\"repository\":\"dewadavidweb/features-api\",\"specPath\":\"features.json\",\"apiKeyName\":\"AUTORESTTEST_API_KEY\"},
              user_id: 'user_34JbEVSt2M9RUA7qaBE2SYPQ85z'
            };
            console.log(JSON.stringify(data));
          ")

          curl -f -X POST https://art.dvad.my.id/api/v1/jobs \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.AUTORESTTEST_API_KEY }}" \
            -d "$PAYLOAD"
